---
layout: default
tag: 1carticle
title: Запуск отчета СКД в привилегированном режиме 1C.
photo_url: /images/2014-12-08-zapusk-otcheta-skd-v-privilegirovannom-rezhime-1c/head.png
excerpt_separator: <!--more-->
---
<!--Иногда возникают ситуации, когда нужно дать пользователю возможность запускать отчет не смотря на права (в привилегированном режиме).В статье мы рассмотрим два возможных запуска отчета в привилегированном режиме.-->
<!--more-->
<div class="container">

  <div class="row">
    <div class="col-sm-1"></div>
    <div class="col-sm-10">
      <h2><p class="text-center text-uppercase">Запуск отчета СКД в привилегированном режиме 1C.</p></h2>
    </div>
    <div class="col-sm-1"></div>
  </div>

  <div class="row">
    <div class="col-sm-1"></div>
    <div class="col-sm-10">
      <p class="text-fluid">Иногда возникают ситуации, когда нужно дать пользователю возможность запускать отчет не смотря на права (в привилегированном режиме). Один из примеров – когда твой Team Lead запретил добавление новых ролей к базе, «потому что итак все глючит», а заказчик (начальник) хочет, чтобы пользователи могли смотреть супер важную аналитику по регистрам из самописных (костылей) подсистем. В статье мы рассмотрим два возможных запуска отчета в привилегированном режиме:</p>
      <ul>
        <li>Из использованием вида набора данных «Объект»;</li>
        <li>Из подменой текста запроса набора данных «Запрос».</li>
      </ul>
    <p class="text-fluid">Для возможности проверки результатов создадим тестовую конфигурацию, куда добавим два пользователя: администратор и менеджер.  У менеджера будет ограничение по правам – ему будет недоступен для чтения регистр «Продажи». Попробуем построить отчеты по регистру «Продажи» и посмотрим что у нас получится. Выгруженную конфигурацию можно скачать на Bitbucket.</p>
    <div class="alert alert-info" role="alert"><p class="text-uppercase"><h3>ОТЧЕТ С НАБОРОМ ДАННЫХ «ОБЪЕКТ»</h3></p></div>
    <p class="text-fluid">Метод очень хорошо описан и в интернете, и в литературе. Суть заключается в переопределении обработчика «При компоновке результата», в котором мы программно формируем таблицу значений, которую потом загружаем в наш отчет. Приведем код обработчика.</p>
    <script src="https://gist.github.com/0xporky/f5d09697f162e2e3d2ef4b0b2a1ee77e.js"></script> 
    <p class="text-fluid">В обработке мы отказываемся от стандартной обработки компоновки отчета и перенаправляем процедуру формирования отчета в общий модуль, в котором установлена галочка «привилегированный». Код в общем модуле стандартный, приведем его.</p>
    <script src="https://gist.github.com/0xporky/63d18db92dd33e991c099dce16afe387.js"></script>
    <p class="text-fluid">Сначала мы получаем таблицу значений (ТаблицаПродаж) из колонками (Номенклатура, Количество, Сумма). Потом таблица загружается в внешний набор данных. В результате чего у пользователя «Менеджер» (с ограниченными правами) будет сформирован следующий отчет.</p>
    <div class="text-center"> 
      <img src="/images/2014-12-08-zapusk-otcheta-skd-v-privilegirovannom-rezhime-1c/otchetchereznabor.png" class="img-fluid" alt="Програмный вывод отчета через внешний набор данных">
    </div>
    <div class="alert alert-info" role="alert"><p class="text-uppercase"><h3>ОТЧЕТ ИЗ ПОДМЕНОЙ ТЕКСТА ЗАПРОСА СКД</h3></p></div>
    <p class="text-fluid">Для начала сформируем набор СКД «заглушку», которую будем использовать далее для подмены текста запроса.</p>
    <div class="text-center">
      <img src="/images/2014-12-08-zapusk-otcheta-skd-v-privilegirovannom-rezhime-1c/skdzaglushka.png" class="img-fluid" alt="Заглушка СКД для подмены запроса">
    </div> 
    <p class="text-fluid">Для того, чтобы облегчить себе последующие мучения – сформируем так же настройки компоновки, менять из процессе вывода результата не будем.</p>
    <div class="text-center">
      <img src="/images/2014-12-08-zapusk-otcheta-skd-v-privilegirovannom-rezhime-1c/nastroykikomponovki.jpg" class="img-fluid" alt="Настройки макета СКД отчета">
    </div> 
      <p class="text-fluid">Следующий наш шаг – предопределить процедуру обработчика «При компоновке результата», как и предыдущем способе.</p>
      <script src="https://gist.github.com/0xporky/e1962b17c50e5dae7f84d1c6cfdb3169.js"></script> 
      <p class="text-fluid">Как видно из кода – мы аналогично отказываемся от стандартной обработки процедуры и перенаправляем поток выполнения в общий модуль из галочкой «привилегированный». Давайте посмотрим на процедуру «СформироватьОтчетПодменаЗапросаСКД».</p>
      <script src="https://gist.github.com/0xporky/25f7deb554b1b7c55d8d879335979531.js"></script>
      <p class="text-fluid">Сначала мы получаем текст необходимого запроса (переменная ТекстЗапроса). Далее устанавливаем текст запроса в основной набор компоновки, а потом уже применяем пользовательские настройки, которые установил пользователь и выводим результат. Хочу также обратить внимание на то, что последний параметр КомпоновщикМакета.Выполнить необходимо устанавливать в Ложь, тогда компоновщик макета будет игнорировать доступность полей отчета по правам.</p>
    <div class="text-center">
     <img src="/images/2014-12-08-zapusk-otcheta-skd-v-privilegirovannom-rezhime-1c/podmenazaprosaskd.png" class="img-fluid" alt="Результат вывода отчета подмена запроса СКД">
    </div> 
    <p class="text-fluid">Итак, почему же я вижу второй вариант предпочтительнее первого. Второй вариант делает выполнение отчета более гибким и оптимальным, поскольку СКД умеет самостоятельно оптимизировать код запроса. В первом варианте мы сначала выполняем построение таблицы, а уже потом загрузку. Если пользователь установит дополнительный отбор – СКД его выполнит уже к сформированной таблице, а во втором варианте отбор отработает непосредственно в основном запросе. В результате отчет будет выполняться быстрее.</p>
    </div>
    <div class="col-sm-1"></div>
  </div>

</div>
